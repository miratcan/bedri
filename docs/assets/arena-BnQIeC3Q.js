(function(){"use strict";const g=(e,t,o)=>{const n=e.getImageData(0,0,t,o).data,s=t*o,f=new Float32Array(s);for(let l=0;l<s;l++){const d=l*4,m=n[d],v=n[d+1],A=n[d+2];f[l]=.299*m+.587*v+.114*A}return f},M=e=>{const t=Math.floor(Math.random()*360),o=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`hsla(${t}, ${o}%, ${n}%, ${e})`},D=(e,t)=>{const o=Math.floor(Math.random()*t.blocks.length);return{text:t.blocks[o],size:Math.random()*(t.font.maxSize-t.font.minSize)+t.font.minSize,position:{x:Math.random()*e.size.width,y:Math.random()*e.size.height},color:M(t.font.opacity),rotation:Math.random()*Math.PI-Math.PI/2}},I=(e,t,o)=>[...Array(o)].map(()=>D(e,t)),w=(e,t,o,n)=>{n.putImageData(e.iData,0,0);const s=o.font.bold?"bold":"normal";n.font=`${s} ${t.size}px ${o.font.family}`,n.fillStyle=t.color,n.textAlign="center",n.textBaseline="middle",n.translate(t.position.x,t.position.y),n.rotate(t.rotation),n.fillText(t.text,0,0),n.rotate(-t.rotation),n.translate(-t.position.x,-t.position.y)},k=(e,t,o,n,s)=>{w(e,t,n,s);const f=g(s,o.size.width,o.size.height);let l=0;for(let d=0;d<o.bArray.length;d++){const m=f[d]-o.bArray[d];l+=m*m}return l/=o.bArray.length,1/(l+1e-4)};let r,i,h,p,c,u,a,z=null;function x(e){if(e.workerId===void 0){self.postMessage({action:"error",reason:"You need to send workerId to prepare an arena.",timestamp:Date.now(),workerId:-1});return}if(r=e.workerId,i=e.selectedImage,u=new OffscreenCanvas(i.size.width,i.size.height),a=u.getContext("2d",{willReadFrequently:!0}),!a)throw new Error("Failed to get 2D context");a.fillStyle="black",a.fillRect(0,0,i.size.width,i.size.height),h={iData:a.getImageData(0,0,i.size.width,i.size.height),size:{width:i.size.width,height:i.size.height},bArray:new Float32Array(i.size.width*i.size.height)},self.postMessage({action:"ready",timestamp:Date.now(),workerId:r})}function b(e){if(!e){self.postMessage({action:"error",reason:"No data provided for initialization",timestamp:Date.now(),workerId:r});return}if(!e.nofCandidates){self.postMessage({action:"error",reason:"nofCandidates not provided for initialization",timestamp:Date.now(),workerId:r});return}if(!e.options){self.postMessage({action:"error",reason:"options not provided for initialization",timestamp:Date.now(),workerId:r});return}e.legend&&(z=e.legend,a.putImageData(h.iData,0,0),w(h,z,e.options,a),h={iData:a.getImageData(0,0,i.size.width,i.size.height),size:{width:i.size.width,height:i.size.height},bArray:g(a,i.size.width,i.size.height)}),p=e.options,c=I(i,p,e.nofCandidates),self.postMessage({action:"debug",type:"candidates",candidates:c,workerId:r,timestamp:Date.now()}),self.postMessage({action:"initialized",timestamp:Date.now(),workerId:r})}function y(){if(!c||c.length===0){self.postMessage({action:"error",reason:"No candidates to process. Enter must be called first to generate candidates.",timestamp:Date.now(),workerId:r});return}if(!a){self.postMessage({action:"error",reason:"No canvas context found. Enter must be called first to generate candidates.",timestamp:Date.now(),workerId:r});return}let e;for(let t=0;t<c.length;t++){self.postMessage({action:"update",total:c.length,processed:t+1,timestamp:Date.now(),workerId:r});const o=c[t],n=k(h,o,i,p,a),s={...o,score:n};if(e===void 0){e=s;continue}if(e.score<=s.score){e=s;continue}}self.postMessage({action:"done",victor:{candidate:e,score:e.score||0},timestamp:Date.now(),workerId:r})}self.onmessage=e=>{const{data:t}=e,{action:o}=t;switch(o){case"prepare":x(t);break;case"enter":b(t);break;case"battle":y();break}}})();
